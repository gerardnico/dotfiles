#!/bin/bash
# Shows the pods ip (node name can be given for a smaller subset)

# flag
# e - Exit if any error
# u - Treat unset variables as an error when substituting
# o pipefail - the return value of a pipeline is the status of the last command to exit with a non-zero status or zero if no command exited with a non-zero status
# E - the ERR trap is inherited by shell functions
set -Eeuo pipefail

# Check if the node name is provided
if [ -n "$1" ]; then
  NAMESPACE_JSONPATH="{range .items[?(@.spec.nodeName==\"$1\")]}{.status.podIP}{\" \"}{.metadata.name}{\"\n\"}{end}"
  # shellcheck disable=SC2016
  AWK_PRINTF='
              BEGIN { print "IP      POD NAME   "
                      print "----      ------     --------  ----------------" }
                    { printf "%12s  %s\n", $1, $2}
              '
else
  NAMESPACE_JSONPATH='{range .items[*]}{.status.podIP}{" "}{.spec.nodeName}{" "}{.metadata.name}{"\n"}{end}'
  # shellcheck disable=SC2016
  AWK_PRINTF='
            BEGIN { print "IP            NODE NAME                       POD NAME   "
                    print "------------  ------------------------------- ---------------------------" }
                  { printf "%12s  %-30s %s\n", $1, $2, $3}
            '
fi


kubectl get pods --all-namespaces -o jsonpath="$NAMESPACE_JSONPATH" | awk "$AWK_PRINTF"