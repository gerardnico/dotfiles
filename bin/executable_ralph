#!/bin/bash
# afk-ralph.sh â€” Fully automated Ralph loop
# Usage: ./afk-ralph.sh <iterations>
# Ref: https://ralph-specs.vercel.app/

set -e
ITERATIONS=${1:-50}
echo "ğŸš€ Starting Ralph with $ITERATIONS iterations..."

for ((i = 1; i <= ITERATIONS; i++)); do
  echo "ğŸ”„ Iteration $i of $ITERATIONS"

  result=$(claude --permission-mode bypassPermissions -p "@PRD.md @progress.txt \
You are building this project based on the PRD.

WORKFLOW:
1. Read the PRD and progress.txt carefully
2. Find the NEXT INCOMPLETE TASK (marked with [ ])
3. Implement that ONE task completely
4. Run checks: typecheck and lint
5. Commit and update BOTH files:
    - PRD.md: Change [ ] to [x] for the completed task
    - progress.txt: Add task number, timestamp, and notes

If ALL tasks complete, output: <promise>COMPLETE</promise>")

  echo "$result"

  if [[ "$result" == *"<promise>COMPLETE</promise>"* ]]; then
    echo "ğŸ‰ All tasks COMPLETE!"
    exit 0
  fi
done

echo "â¸ï¸ Reached $ITERATIONS iterations. Run again to continue."
